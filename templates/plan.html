{% extends 'base.html' %}
{% block content %}

{% if mode == 'good' %}
  {% set help = {
    'leeftijd': ['Leeftijd','Leeftijd be√Ønvloedt vaak je draagkracht en horizon. Jonger = meestal langere horizon.'],
    'inkomen': ['Netto maandinkomen','Nodig om je inlegruimte te schatten (na vaste lasten en pensioeninleg).'],
    'spaardoel': ['Spaardoel','Helpt de balans te vinden tussen sparen (korter) en beleggen (langer).'],
    'horizon_maanden': ['Beleggingshorizon','Kortere horizon ‚Üí defensiever plan (meer obligaties/cash).'],
    'ervaring_select': ['Ervaring','Zelfinschatting: geen, licht, gemiddeld of veel.'],
    'buffer_maanden': ['Buffer','Maanden vaste lasten die je direct kunt betalen. Lage buffer vergroot risico.'],
    'vaste_lasten': ['Vaste lasten','Woonlasten, verzekeringen etc. Gaan van je inkomen af.'],
    'pensioen_inleg': ['Pensioen-inleg','Maandelijkse storting; telt mee bij je vrije ruimte.'],
    'belasting_schatting': ['Belasting','Ruwe inschatting van je effectieve tarief (%).'],
    'krediet_bedrag': ['Kredietschuld','Totaal consumptief krediet/roodstand.'],
    'krediet_rente': ['Rente op krediet','Hoge rente (>5%) is een signaal om eerst (deels) af te lossen.'],
    'hypotheek_rente': ['Hypotheekrente','Be√Ønvloedt totale lastendruk.'],
    'kosten_sensitiviteit': ['Kosten-prioriteit','0=geen, 1=matig, 2=hoog. Hoger = voorkeur voor fondsen met lagere kosten (TER).'],
    'duurzaam_voorkeur': ['Duurzaam','Bij voorkeur ESG-voorbeelden.'],
    'data_share_optin': ['Gegevens delen voor modelverbetering','Als je dit aanzet, slaan we jouw ingevulde velden en geanonimiseerde plan-uitkomsten lokaal op voor het verbeteren en valideren van het model. We bewaren geen identificerende gegevens (zoals naam/IBAN) en delen niets met derden. Je kunt dit op elk moment weer uitzetten.'],
    'inleg': ['Maand-inleg','Laat leeg voor een voorstel op basis van je profiel.']
  } %}
{% endif %}

<style>
  .help-toggle-btn{ border:0; width:1.6rem; height:1.6rem; border-radius:999px;
    display:inline-flex; align-items:center; justify-content:center;
    background:#eef2ff; color:#334155; font-weight:700; line-height:1; }
  .help-toggle-btn:focus{ outline:2px solid #93c5fd; }
  .help-pane{ background:#f8fafc; border:1px dashed #cbd5e1; border-radius:.5rem; padding:.5rem .75rem; margin-top:.5rem; }
  .ad-crypto{ background:linear-gradient(135deg,#111827,#0f172a); color:#e5e7eb; border-radius:.75rem; }
  .ad-crypto .badge{ background:#22c55e; }
</style>

{% macro label_with_help(name, label_text) -%}
  <div class="d-flex justify-content-between align-items-center">
    <label class="form-label mb-0" for="{{ name }}">{{ label_text }}</label>
    {% if mode == 'good' and help.get(name) %}
      {% set cid = 'help_' ~ name %}
      <button class="help-toggle-btn" type="button"
              data-bs-toggle="collapse"
              data-bs-target="#{{ cid }}"
              aria-expanded="false"
              aria-controls="{{ cid }}"
              title="Meer informatie">?</button>
    {% endif %}
  </div>
  {% if mode == 'good' and help.get(name) %}
    {% set cid = 'help_' ~ name %}
    <div id="{{ cid }}" class="collapse help-pane small">
      <strong>{{ help[name][0] }} ‚Äî waarom?</strong><br>
      {{ help[name][1] }}
    </div>
  {% endif %}
{%- endmacro %}

<div class="row g-4">
  <!-- Invoer -->
  <div class="col-12 col-lg-5">
    <div class="card shadow-sm">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-1">
          <h5 class="card-title mb-0">Profiel & Plan ({{ 'GOED' if mode=='good' else 'SLECHT' }})</h5>
          {% if mode == 'bad' %}
            <span class="badge text-bg-warning">‚ö†Ô∏è Demo-variant</span>
          {% endif %}
        </div>

        {% if mode == 'bad' %}
          <div class="alert alert-success d-flex align-items-start gap-2">
            <div class="fw-bold">Begin direct met je plan</div>
            <div class="small">Onze smart-engine regelt het voor je. <u>Vandaag starten = sneller resultaat.</u></div>
          </div>
        {% endif %}

        <form method="post" id="main-form">
          {% for name, meta in fields.items() %}
            <div class="mb-3">
              {{ label_with_help(name, meta.label) }}
              {% if name == 'ervaring_select' %}
                <select id="ervaring_select" name="ervaring_select" class="form-select">
                  <option value="" {% if sticky.get('ervaring_select','')=='' %}selected{% endif %}>‚Äî kies ‚Äî</option>
                  <option value="geen" {% if sticky.get('ervaring_select')=='geen' %}selected{% endif %}>Geen</option>
                  <option value="licht" {% if sticky.get('ervaring_select')=='licht' %}selected{% endif %}>Licht</option>
                  <option value="gemiddeld" {% if sticky.get('ervaring_select')=='gemiddeld' %}selected{% endif %}>Gemiddeld</option>
                  <option value="veel" {% if sticky.get('ervaring_select')=='veel' %}selected{% endif %}>Veel</option>
                </select>
              {% elif meta.type == 'checkbox' %}
                {% set checked = (sticky.get(name) in ['1','on','true',true]) or meta.get('checked') %}
                <div>
                  <input class="form-check-input" type="checkbox" id="{{ name }}" name="{{ name }}" {% if checked %}checked{% endif %}>
                </div>
              {% else %}
                <input class="form-control" type="{{ meta.type }}" id="{{ name }}" name="{{ name }}"
                       value="{{ sticky.get(name, '') }}"
                       min="{{ meta.get('min','') }}" max="{{ meta.get('max','') }}">
              {% endif %}
            </div>
          {% endfor %}

          <div class="mb-3">
            {{ label_with_help('inleg', 'Maand-inleg (‚Ç¨)') }}
            <div class="text-muted small mb-1">(leeg = voorstel o.b.v. jouw profiel)</div>
            <input class="form-control" id="inleg" name="inleg" type="number" min="10" step="10" value="{{ sticky.get('inleg','') }}">
          </div>

          <div class="d-flex gap-2">
            <button type="submit" class="btn {{ 'btn-primary' if mode=='good' else 'btn-danger' }}">Genereer plan</button>
            <a class="btn btn-outline-secondary" href="{{ url_for('plan') }}">Reset</a>
          </div>
        </form>

        {% if errors and errors|length %}
          <div class="alert alert-danger mt-3">
            <ul class="mb-0">{% for e in errors %}<li>{{ e }}</li>{% endfor %}</ul>
          </div>
        {% endif %}

        {% if mode == 'bad' %}
          <hr>
          <div class="small">
            <div class="alert alert-info mb-2">
              <strong>Waarom wachten?</strong> Wij optimaliseren terwijl jij doorgaat met je dag.
            </div>
            <ul class="mb-3">
              <li><strong>Automatisch uitvoeren</strong> ‚Äì jij hoeft niets te doen</li>
              <li><strong>Snelle start</strong> ‚Äì vandaag geregeld</li>
              <li><strong>Persoonlijk team</strong> ‚Äì monitoren & bijsturen</li>
            </ul>
          </div>
        {% endif %}
      </div>
    </div>

    {% if mode == 'bad' %}
    <!-- Crypto casino advertentie (alleen slechte modus) -->
    <div class="card ad-crypto shadow-sm mt-3">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-start">
          <h6 class="mb-2">üî• Promo: LunaSpin Crypto Casino</h6>
          <span class="badge">Welkomstbonus 200%</span>
        </div>
        <p class="small mb-2">Zet je rendement in een stroomversnelling: snelle stortingen, instant withdraws, dagelijkse jackpots.</p>
        <ul class="small mb-3">
          <li>Start in 60 seconden ‚Äî alleen een wallet nodig</li>
          <li>Dagelijkse ‚Äúboost‚Äù-bonussen bij iedere storting</li>
          <li>VIP-programma met verhoogde uitbetalingen</li>
        </ul>
        <a class="btn btn-success btn-sm" href="#" onclick="return false;">Aanmelden</a>
      </div>
    </div>
    {% endif %}
  </div>

  <!-- Output -->
  <div class="col-12 col-lg-7">
    <div class="card shadow-sm mb-4">
      <div class="card-body">
        <h5 class="card-title">Voorstel</h5>

        {% if not plan %}
          <p class="text-muted">Vul links je profiel in en klik op <em>Genereer plan</em>.</p>
        {% else %}
          {% if mode == 'bad' %}
            <div class="alert alert-success small">
              <strong>Klaar om te starten!</strong> Onze engine volgt de markt en benut kansen automatisch.
            </div>
          {% endif %}

          <div class="row">
            <div class="col-12 col-md-6">
              <h6 class="mb-2">Allocatie</h6>
              <ul class="mb-3">
                <li>Aandelen: {{ (plan.alloc.equity*100)|round(0) }}% ¬∑ ~ ‚Ç¨{{ plan.monthly_per_bucket.equity }} p/m</li>
                <li>Obligaties: {{ (plan.alloc.bonds*100)|round(0) }}% ¬∑ ~ ‚Ç¨{{ plan.monthly_per_bucket.bonds }} p/m</li>
                <li>Cash: {{ (plan.alloc.cash*100)|round(0) }}% ¬∑ ~ ‚Ç¨{{ plan.monthly_per_bucket.cash }} p/m</li>
              </ul>

              <h6 class="mb-2">Maand-inleg</h6>
              <p class="mb-0">
                Aanbevolen: <strong>‚Ç¨{{ plan.suggested_inleg }}</strong><br>
                In plan: <strong>‚Ç¨{{ plan.inleg }}</strong>
              </p>
            </div>

            <div class="col-12 col-md-6">
              <h6 class="mb-2">Projectie (simulaties)</h6>
              <ul class="small mb-2">
                <li>P10: ‚Ç¨{{ plan.projection.p10|round(0) }}</li>
                <li>Mediaan: ‚Ç¨{{ plan.projection.median|round(0) }}</li>
                <li>P90: ‚Ç¨{{ plan.projection.p90|round(0) }}</li>
              </ul>

              {% if mode == 'good' %}
                <div class="alert alert-light border small">
                  <strong>Hoe lees je dit?</strong><br>
                  ‚Ä¢ <em>P10</em>: Voorzichtige uitkomst ‚Äî in 10% van de scenario‚Äôs is het resultaat lager dan dit bedrag.<br>
                  ‚Ä¢ <em>Mediaan</em>: Middenverwachting ‚Äî in de helft van de scenario‚Äôs hoger, in de helft lager.<br>
                  ‚Ä¢ <em>P90</em>: Optimistische uitkomst ‚Äî in 10% van de scenario‚Äôs hoger dan dit bedrag.<br>
                  Deze bandbreedte is gebaseerd op maandelijkse simulaties met een vaste verdeling (aandelen/obligaties/cash),
                  aannames over rendement/volatiliteit en verrekening van geschatte kosten.
                </div>
              {% endif %}

              {% if mode == 'good' %}
                <div class="alert alert-info small mt-2">
                  <strong>Advies:</strong> {{ plan.advice }}
                </div>
              {% else %}
                <div class="alert alert-warning small mt-2">
                  <strong>Aanbevolen:</strong> Start het plan automatisch ‚Äî je profiteert direct zonder gedoe.
                </div>
              {% endif %}
            </div>
          </div>

          {% if mode == 'good' %}
            <hr>
            <h6>Voorbeeldbeleggingen</h6>
            <div class="row">
              <div class="col-12 col-md-6">
                <strong>Aandelen</strong>
                <ul class="small">
                  {% for f in plan.holdings.equity %}<li>{{ f.name }} ({{ f.ticker }}) ‚Äî TER {{ f.er }}%</li>{% endfor %}
                </ul>
                <strong>Obligaties</strong>
                <ul class="small">
                  {% for f in plan.holdings.bonds %}<li>{{ f.name }} ({{ f.ticker }}) ‚Äî TER {{ f.er }}%</li>{% endfor %}
                </ul>
                <strong>Cash</strong>
                <ul class="small">
                  {% for f in plan.holdings.cash %}<li>{{ f.name }} ({{ f.ticker }}) ‚Äî TER {{ f.er }}%</li>{% endfor %}
                </ul>
              </div>
              <div class="col-12 col-md-6">
                <div class="alert alert-secondary small">
                  <strong>Waarom deze verdeling?</strong>
                  <ul class="mb-0">{% for r in plan.risk_ui.reasons %}<li>{{ r }}</li>{% endfor %}</ul>
                </div>
              </div>
            </div>
          {% else %}
            <hr>
            <form method="post" action="{{ url_for('managed_start') }}">
              <div class="form-check mb-2">
                <input class="form-check-input" type="checkbox" id="autoManage" name="autoManage" checked>
                <label class="form-check-label" for="autoManage">Laat ons dit plan uitvoeren voor jou (aanbevolen).</label>
              </div>
              <button type="submit" class="btn btn-primary">Plan starten</button>
              <p class="text-muted small mt-2 mb-0">Snel geregeld. Je kunt later altijd bijstellen.</p>
            </form>
          {% endif %}
        {% endif %}
      </div>
    </div>

    <!-- Risico + disclaimers -->
    <div class="card shadow-sm">
      <div class="card-body">
        <h5 class="card-title">Risico-inschatting</h5>
        {% if not plan %}
          <p class="text-muted">Genereer eerst een plan.</p>
        {% else %}
          <p class="mb-2">
            <span class="badge {{ plan.risk_ui.badge }}">{{ plan.risk_ui.level }}</span>
            {% if mode == 'good' %}<span class="text-muted ms-2">Risico-indicator: {{ plan.risk_ui.score }}</span>{% endif %}
          </p>
          {% if plan.risk_ui.reasons and plan.risk_ui.reasons|length %}
            <ul class="small mb-2">{% for r in plan.risk_ui.reasons %}<li>{{ r }}</li>{% endfor %}</ul>
          {% endif %}

          {% if mode == 'good' %}
            <div class="alert alert-light border small mb-2">
              <strong>Transparantie:</strong> de resultaten op deze pagina worden geautomatiseerd gegenereerd door een getraind
              <em>machine-learning</em> model op basis van jouw ingevoerde gegevens en algemene aannames.
              De site geeft geen individuele beleggingsaanbevelingen en is niet verantwoordelijk voor marktdalingen of
              beleggingsbeslissingen die afwijken van het voorgestelde plan.
            </div>
            <div class="alert alert-secondary small mb-0">
              <strong>Gegevens delen voor modelverbetering:</strong>
              {% if plan.flags.data_share_optin %}
                je hebt het delen ingeschakeld. We slaan geanonimiseerde velden en uitkomsten lokaal op voor evaluatie/verbetering.
              {% else %}
                je hebt het delen niet ingeschakeld. Je kunt dit later aanzetten via het vinkje in het formulier.
              {% endif %}
            </div>
          {% else %}
            <div class="alert alert-success small mb-0">
              Goed nieuws: je profiel past bij ons automatische plan. Je kunt direct starten.
            </div>
          {% endif %}
        {% endif %}
      </div>
    </div>
  </div>
</div>

{% endblock %}
